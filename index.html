<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slater's Follow Up App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1050;
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container" class="d-flex align-items-center justify-content-center">
        <div class="card shadow" style="width: 100%; max-width: 400px;">
            <div class="card-body p-5">
                <h3 class="card-title text-center mb-4">Login</h3>
                <form id="login-form">
                    <div class="mb-3">
                        <label for="email-input" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email-input" required>
                    </div>
                    <div class="mb-3">
                        <label for="password-input" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password-input" required>
                    </div>
                    <p id="login-error" class="text-danger small d-none mb-3">Error: Could not log in. Please check your email and password.</p>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application Content (hidden by default) -->
    <div id="app-content" class="d-none">
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container">
                <span class="navbar-brand mb-0 h1">Slater's Follow Up App</span>
                <div class="d-flex align-items-center">
                    <span id="user-email" class="navbar-text me-3 d-none d-sm-block"></span>
                    <button id="signout-btn" class="btn btn-outline-secondary">Sign Out</button>
                </div>
            </div>
        </nav>
        <div class="container my-4 my-lg-5">
            <main class="mx-auto" style="max-width: 800px;">
                <!-- Input Form Card -->
                <div class="card shadow-sm p-4 p-lg-5 mb-5">
                    <h2 class="h3 fw-semibold mb-4">Add New Visit</h2>
                    <form id="customer-form" class="row g-3">
                        <div class="col-md-6">
                            <label for="customer-name" class="form-label">Customer Name</label>
                            <input type="text" id="customer-name" class="form-control" placeholder="e.g., John Doe" required>
                        </div>
                        <div class="col-md-6">
                            <label for="customer-address" class="form-label">Address / Street</label>
                            <input type="text" id="customer-address" class="form-control" placeholder="e.g., 123 Oak Avenue" required>
                        </div>
                        <div class="col-12">
                            <label for="visit-date" class="form-label">Date of Visit</label>
                            <input type="date" id="visit-date" class="form-control" required>
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary px-4 py-2">Add Customer</button>
                        </div>
                    </form>
                </div>
                <!-- Due for Follow-up Section -->
                <div class="mb-5">
                    <h2 class="h3 fw-bold mb-3 d-flex align-items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>
                        Due for Follow-up
                    </h2>
                    <div id="due-list" class="list-group">
                        <p id="no-due-message" class="text-muted p-3">No follow-ups are due right now. Good job!</p>
                    </div>
                </div>
                <!-- Upcoming Follow-ups Section -->
                <div>
                    <h2 class="h3 fw-bold mb-3 d-flex align-items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path></svg>
                        Upcoming
                    </h2>
                    <div id="upcoming-list" class="list-group">
                         <p id="no-upcoming-message" class="text-muted p-3">No upcoming follow-ups scheduled.</p>
                    </div>
                </div>
            </main>
            <!-- Notification Permission Button -->
            <div id="notification-banner" class="d-none position-fixed bottom-0 end-0 m-3 p-3 bg-light border rounded-3 shadow-lg" style="max-width: 350px;">
                <p class="mb-3">Enable desktop notifications to get alerts.</p>
                <button id="enable-notifications" class="w-100 btn btn-success">Enable Notifications</button>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Import Firebase SDKs -->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    // TODO: Add your own Firebase project configuration here
const firebaseConfig = {
  apiKey: "AIzaSyDVNpZJdoH36cnuTAG8yCE-MHTYKu08FMA",
  authDomain: "slaters-dee11.firebaseapp.com",
  projectId: "slaters-dee11",
  storageBucket: "slaters-dee11.firebasestorage.app",
  messagingSenderId: "542128251841",
  appId: "1:542128251841:web:6d87c30c026329fb978540"
};


    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI ELEMENTS ---
    const authContainer = document.getElementById('auth-container');
    const appContent = document.getElementById('app-content');
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const loginError = document.getElementById('login-error');
    const userEmailEl = document.getElementById('user-email');
    const signoutBtn = document.getElementById('signout-btn');
    const customerForm = document.getElementById('customer-form');
    const customerNameInput = document.getElementById('customer-name');
    const customerAddressInput = document.getElementById('customer-address');
    const visitDateInput = document.getElementById('visit-date');
    const dueList = document.getElementById('due-list');
    const upcomingList = document.getElementById('upcoming-list');
    const noDueMessage = document.getElementById('no-due-message');
    const noUpcomingMessage = document.getElementById('no-upcoming-message');
    const notificationBanner = document.getElementById('notification-banner');
    const enableNotificationsBtn = document.getElementById('enable-notifications');
    
    visitDateInput.valueAsDate = new Date();
    let customers = [];
    let currentUser = null;
    let customerDocRef = null;
    let unsubscribe = null; // To detach Firestore listener on sign out

    // --- AUTHENTICATION LOGIC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // User is signed in
            currentUser = user;
            userEmailEl.textContent = user.email;
            authContainer.classList.add('d-none');
            appContent.classList.remove('d-none');
            
            // Set up Firestore reference and listener
            customerDocRef = doc(db, "users", currentUser.uid);
            listenForCustomerUpdates();

        } else {
            // User is signed out
            currentUser = null;
            if(unsubscribe) unsubscribe(); // Stop listening to old data
            authContainer.classList.remove('d-none');
            appContent.classList.add('d-none');
        }
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
            .catch((error) => {
                console.error("Login failed:", error);
                loginError.classList.remove('d-none');
            });
    });

    signoutBtn.addEventListener('click', () => {
        signOut(auth);
    });

    // --- FIRESTORE & CORE APP LOGIC ---
    function listenForCustomerUpdates() {
        unsubscribe = onSnapshot(customerDocRef, (docSnap) => {
            if (docSnap.exists()) {
                customers = docSnap.data().customers || [];
            } else {
                customers = [];
            }
            renderCustomers();
            checkNotificationsOnLoad();
        });
    }
    
    const saveCustomers = () => {
        if (customerDocRef) {
            setDoc(customerDocRef, { customers: customers });
        }
    };

    customerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = customerNameInput.value.trim();
        const address = customerAddressInput.value.trim();
        const visitDate = visitDateInput.value;
        if (!name || !address || !visitDate) return;

        const initialDate = new Date(visitDate);
        const dueDate = new Date(initialDate.setMonth(initialDate.getMonth() + 1));
        const newCustomer = {
            id: Date.now(), name, address, initialDate: visitDate,
            dueDate: dueDate.toISOString().split('T')[0]
        };
        customers.push(newCustomer);
        saveCustomers();
        customerForm.reset();
        visitDateInput.valueAsDate = new Date();
    });
    
    // --- RENDERING LOGIC (Mostly unchanged) ---
    const renderCustomers = () => {
        dueList.innerHTML = '';
        upcomingList.innerHTML = '';
        dueList.appendChild(noDueMessage);
        upcomingList.appendChild(noUpcomingMessage);
        let dueCount = 0;
        let upcomingCount = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const sortedCustomers = [...customers].sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        sortedCustomers.forEach(customer => {
            const dueDate = new Date(customer.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            const isDue = dueDate <= today;
            const customerCard = document.createElement('div');
            customerCard.className = `list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-sm-center gap-3 ${isDue ? 'border-start border-5 border-danger' : 'border-start border-5 border-primary'}`;
            const formattedDueDate = new Date(customer.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            customerCard.innerHTML = `
                <div>
                    <p class="fw-bold h5 mb-1">${customer.name}</p>
                    <p class="text-muted mb-1">${customer.address}</p>
                    <p class="small fw-medium mb-0 ${isDue ? 'text-danger' : 'text-primary'}">Due on: ${formattedDueDate}</p>
                </div>
                <div class="d-flex align-items-center gap-2 flex-shrink-0">
                    ${isDue ? `<button data-id="${customer.id}" class="snooze-btn btn btn-sm btn-warning">Snooze (2 days)</button>` : ''}
                    <button data-id="${customer.id}" class="done-btn btn btn-sm btn-success">Done</button>
                </div>`;
            if (isDue) {
                dueList.appendChild(customerCard);
                dueCount++;
            } else {
                upcomingList.appendChild(customerCard);
                upcomingCount++;
            }
        });
        
        noDueMessage.style.display = dueCount === 0 ? 'block' : 'none';
        noUpcomingMessage.style.display = upcomingCount === 0 ? 'block' : 'none';
        addEventListenersToButtons();
    };

    const addEventListenersToButtons = () => {
        document.querySelectorAll('.done-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = parseInt(e.target.dataset.id);
                customers = customers.filter(c => c.id !== id);
                saveCustomers();
            });
        });
        document.querySelectorAll('.snooze-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = parseInt(e.target.dataset.id);
                const customer = customers.find(c => c.id === id);
                if (customer) {
                    const currentDueDate = new Date(customer.dueDate);
                    currentDueDate.setDate(currentDueDate.getDate() + 2);
                    customer.dueDate = currentDueDate.toISOString().split('T')[0];
                    saveCustomers();
                }
            });
        });
    };

    // --- NOTIFICATION LOGIC (Mostly unchanged) ---
    let notificationPermission = Notification.permission;
    function checkNotificationPermission() {
        if (Notification.permission === 'default') {
            notificationBanner.classList.remove('d-none');
        } else {
            notificationBanner.classList.add('d-none');
        }
    }
    enableNotificationsBtn.addEventListener('click', () => {
        Notification.requestPermission().then(permission => {
            notificationPermission = permission;
            checkNotificationPermission();
            if (permission === 'granted') new Notification('Success!', { body: 'Notifications enabled.' });
        });
    });
    const checkNotificationsOnLoad = () => {
        checkNotificationPermission();
        const dueCustomers = customers.filter(c => {
            const dueDate = new Date(c.dueDate);
            dueDate.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);
            return dueDate <= today;
        });
        if (dueCustomers.length > 0 && notificationPermission === 'granted') {
             new Notification(`${dueCustomers.length} Follow-up(s) Due!`, {
                body: `You have work to do. Open the app to see details.`,
                icon: 'https://placehold.co/48x48/dc3545/ffffff?text=❗'
            });
        }
    };
</script>
</body>
</html>

